var Web3 = require('web3');
var web3 = new Web3();
var iotdatamarketContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"sensor_type","type":"uint256"},{"name":"price","type":"uint256"}],"name":"update_sensor_price","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"kill","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"device_address","type":"address"}],"name":"add_valid_device","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"sensor_type","type":"uint256"},{"name":"index","type":"uint256"}],"name":"query_sensor","outputs":[{"name":"result","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"vendor_address","type":"address"},{"name":"vote","type":"uint256"}],"name":"vote_for_vendor","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"prefix","type":"string"},{"name":"sensors","type":"uint256[]"},{"name":"costs","type":"uint256[]"}],"name":"vendor_register","outputs":[{"name":"result","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"addr","type":"address"}],"name":"get_vendor","outputs":[{"name":"prefix","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"vendor_address","type":"address"},{"name":"sensor_type","type":"uint256"},{"name":"index","type":"uint256"}],"name":"sensor_data_pull","outputs":[{"name":"schema","type":"string"},{"name":"timestamp","type":"uint256"},{"name":"spatial","type":"string"},{"name":"price","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"vendor_length","outputs":[{"name":"length","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"vendor_address","type":"address"},{"name":"sensor_type","type":"uint256"}],"name":"sensor_data_length","outputs":[{"name":"len","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"vendor_address","type":"address"},{"name":"sensor_type","type":"uint256"},{"name":"schema","type":"string"},{"name":"timestamp","type":"uint256"},{"name":"spatial","type":"string"},{"name":"swarm","type":"string"}],"name":"sensor_data_push","outputs":[{"name":"result","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"vendor_address","type":"address"},{"name":"sensor_type","type":"uint256"},{"name":"index","type":"uint256"}],"name":"pay_for_data","outputs":[{"name":"swarm","type":"string"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[{"name":"sensor_type_index","type":"uint256"}],"name":"get_sensor_price","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]);
var contractaddress="0x342291c8c89e045f043ca01738d080496b6887de";
var contract = iotdatamarketContract.at(contractaddress);

/*
var iotdatamarket = iotdatamarketContract.new(
   {
     from: web3.eth.accounts[0], 
     data: '0x6060604052341561000f57600080fd5b336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550611fca8061005e6000396000f3006060604052600436106100c5576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680633ee0a47b146100ca57806341c0e1b51461010e5780635e8b77aa1461012357806396f87125146101745780639e2ff664146101e0578063bf0a56c31461023a578063d45c69651461032f578063de899c5c146103e1578063e06044481461051f578063e10154ad14610548578063ed0de4bd1461059e578063fa51f7b2146106ca578063ff61b95e14610783575b600080fd5b34156100d557600080fd5b6100f460048080359060200190919080359060200190919050506107ba565b604051808215151515815260200191505060405180910390f35b341561011957600080fd5b610121610896565b005b341561012e57600080fd5b61015a600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610927565b604051808215151515815260200191505060405180910390f35b341561017f57600080fd5b61019e6004808035906020019091908035906020019091905050610a6c565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34156101eb57600080fd5b610220600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091908035906020019091905050610bf9565b604051808215151515815260200191505060405180910390f35b341561024557600080fd5b610315600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919080359060200190820180359060200190808060200260200160405190810160405280939291908181526020018383602002808284378201915050505050509190803590602001908201803590602001908080602002602001604051908101604052809392919081815260200183836020028082843782019150505050505091905050610e50565b604051808215151515815260200191505060405180910390f35b341561033a57600080fd5b610366600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506110a6565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156103a657808201518184015260208101905061038b565b50505050905090810190601f1680156103d35780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156103ec57600080fd5b61042a600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091908035906020019091908035906020019091905050611190565b604051808060200185815260200180602001848152602001838103835287818151815260200191508051906020019080838360005b8381101561047a57808201518184015260208101905061045f565b50505050905090810190601f1680156104a75780820380516001836020036101000a031916815260200191505b50838103825285818151815260200191508051906020019080838360005b838110156104e05780820151818401526020810190506104c5565b50505050905090810190601f16801561050d5780820380516001836020036101000a031916815260200191505b50965050505050505060405180910390f35b341561052a57600080fd5b610532611495565b6040518082815260200191505060405180910390f35b341561055357600080fd5b610588600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919080359060200190919050506114a2565b6040518082815260200191505060405180910390f35b34156105a957600080fd5b6106b0600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803590602001909190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803590602001909190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050611503565b604051808215151515815260200191505060405180910390f35b610708600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919080359060200190919080359060200190919050506117d2565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561074857808201518184015260208101905061072d565b50505050905090810190601f1680156107755780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561078e57600080fd5b6107a46004808035906020019091905050611b85565b6040518082815260200191505060405180910390f35b600060011515600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101600085815260200190815260200160002060009054906101000a900460ff1615151415156108335760009050610890565b81600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600201600085815260200190815260200160002081905550600190505b92915050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415610925576000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff5b565b600060011515600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16151514156109cb5760009050610a67565b60018060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908315150217905550600190505b919050565b60006001151560016000600385815481101515610a8557fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101600085815260200190815260200160002060009054906101000a900460ff161515141580610bac5750600060016000600385815481101515610b2c57fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301600085815260200190815260200160002080549050145b15610bb657600080fd5b600382815481101515610bc557fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905092915050565b600060011515600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615151415610e45576001821415610cf25760018060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060050160008282540192505081905550610da4565b600082148015610d4457506000600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060050154115b15610d9e5760018060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060050160008282540392505081905550610da3565b600080fd5b5b6000600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555060019050610e4a565b600090505b92915050565b6000806000600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001805460018160011615610100020316600290049050141515610ebc576000915061109e565b84600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000019080519060200190610f12929190611c5a565b50600090505b83518110156110365760018060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160008684815181101515610f7457fe5b90602001906020020151815260200190815260200160002060006101000a81548160ff0219169083151502179055508281815181101515610fb157fe5b90602001906020020151600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206002016000868481518110151561100d57fe5b906020019060200201518152602001908152602001600020819055508080600101915050610f18565b6003805480600101828161104a9190611cda565b9160005260206000209001600033909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050600191505b509392505050565b6110ae611d06565b600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156111845780601f1061115957610100808354040283529160200191611184565b820191906000526020600020905b81548152906001019060200180831161116757829003601f168201915b50505050509050919050565b611198611d06565b60006111a2611d06565b6000600160008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060030160008781526020019081526020016000208581548110151561120457fe5b9060005260206000209060040201600201600160008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060030160008881526020019081526020016000208681548110151561127557fe5b906000526020600020906004020160000154600160008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003016000898152602001908152602001600020878154811015156112e757fe5b9060005260206000209060040201600301600160008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160008a815260200190815260200160002054838054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156113e15780601f106113b6576101008083540402835291602001916113e1565b820191906000526020600020905b8154815290600101906020018083116113c457829003601f168201915b50505050509350818054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561147d5780601f106114525761010080835404028352916020019161147d565b820191906000526020600020905b81548152906001019060200180831161146057829003601f168201915b50505050509150935093509350935093509350935093565b6000600380549050905090565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301600083815260200190815260200160002080549050905092915050565b600060011515600160008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101600088815260200190815260200160002060009054906101000a900460ff16151514151561157c57600090506117c8565b60011515600160008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16151514151561161f57600090506117c8565b600160008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001600160008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000190805460018160011615610100020316600290046116c2929190611d1a565b50600160008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301600087815260200190815260200160002080548060010182816117289190611da1565b91600052602060002090600402016000608060405190810160405280888152602001868152602001898152602001878152509091909150600082015181600001556020820151816001019080519060200190611785929190611dd3565b5060408201518160020190805190602001906117a2929190611dd3565b5060608201518160030190805190602001906117bf929190611dd3565b50505050600190505b9695505050505050565b6117da611d06565b600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160008481526020019081526020016000205434101561183a57600080fd5b600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001805480600101828161188e9190611da1565b91600052602060002090600402016000600160008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003016000878152602001908152602001600020858154811015156118fe57fe5b906000526020600020906004020190919091506000820154816000015560018201816001019080546001816001161561010002031660029004611942929190611e53565b506002820181600201908054600181600116156101000203166002900461196a929190611e53565b5060038201816003019080546001816001161561010002031660029004611992929190611e53565b505050506001600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508373ffffffffffffffffffffffffffffffffffffffff166108fc349081150290604051600060405180830381858888f1935050505015611b7957600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301600084815260200190815260200160002082815481101515611ac857fe5b90600052602060002090600402016001018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611b6d5780601f10611b4257610100808354040283529160200191611b6d565b820191906000526020600020905b815481529060010190602001808311611b5057829003601f168201915b50505050509050611b7e565b600080fd5b9392505050565b600060011515600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101600084815260200190815260200160002060009054906101000a900460ff161515141515611bfe5760009050611c55565b600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160008381526020019081526020016000205490505b919050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10611c9b57805160ff1916838001178555611cc9565b82800160010185558215611cc9579182015b82811115611cc8578251825591602001919060010190611cad565b5b509050611cd69190611eda565b5090565b815481835581811511611d0157818360005260206000209182019101611d009190611eda565b5b505050565b602060405190810160405280600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10611d535780548555611d90565b82800160010185558215611d9057600052602060002091601f016020900482015b82811115611d8f578254825591600101919060010190611d74565b5b509050611d9d9190611eda565b5090565b815481835581811511611dce57600402816004028360005260206000209182019101611dcd9190611eff565b5b505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10611e1457805160ff1916838001178555611e42565b82800160010185558215611e42579182015b82811115611e41578251825591602001919060010190611e26565b5b509050611e4f9190611eda565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10611e8c5780548555611ec9565b82800160010185558215611ec957600052602060002091601f016020900482015b82811115611ec8578254825591600101919060010190611ead565b5b509050611ed69190611eda565b5090565b611efc91905b80821115611ef8576000816000905550600101611ee0565b5090565b90565b611f5391905b80821115611f4f57600080820160009055600182016000611f269190611f56565b600282016000611f369190611f56565b600382016000611f469190611f56565b50600401611f05565b5090565b90565b50805460018160011615610100020316600290046000825580601f10611f7c5750611f9b565b601f016020900490600052602060002090810190611f9a9190611eda565b5b505600a165627a7a72305820168e7c26a09112b58e487b35cc74e0b6f5ce57e913f5dd75188a0813621306190029', 
     gas: '4700000'
   }, function (e, contract){
    console.log(e, contract);
    if (typeof contract.address !== 'undefined') {
         console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
    }
 })
 */
web3.setProvider(new web3.providers.HttpProvider('http://localhost:8000')) ;

if(!web3.isConnected()) {
    console.log("Cannot connect to web3 provider.");
}

if(web3.isConnected()) {
    console.log("Connected!");
}

//0xc763ebd63027a8a06e2ac233e9aac79d7e908bc7 
//123456
//string prefix, uint[] sensors, uint[] costs

//vendor_register (string prefix, uint[] sensors, uint[] costs) 
window.regVendor = function(fromaddr,password,prefix,sensors,costs){
	web3.personal.unlockAccount(fromaddr,password,30); 
	var x = contract.vendor_register(prefix,sensors,costs,{from:fromaddr,gas:3000000});
	console.log(x);
	console.log("regVendor calling from contract");
}

//function vendor_length () 
window.getVendorLength = function(fromaddr,password){
	web3.personal.unlockAccount(fromaddr,password,30); 
	var x = contract.vendor_length({from:fromaddr});
	console.log(x.toString(20));
	console.log("waiting for length of vendors");
}

//sensor_data_pull(address vendor_address, uint sensor_type, uint index)

window.getSensorsList = function(fromaddr,password){
	web3.personal.unlockAccount(fromaddr,password,30);
	var sensorList = [];

	for(var i=0 ; i< 10 ; i++){
		var priceOf = contract.getSensorPrice(i);
		var tuple = [] ;
		if(priceOf>0){
			tuple.push(i);
			tuple.push(priceOf.toNumber());
			sensorList.push(tuple);
		}

	}
	return(sensorList);
}

window.querySensor = function(fromaddr,password,sensor_type){
	web3.personal.unlockAccount(fromaddr,password,30);
	//console.log(sensor_type);
	var x = contract.vendor_length({from:fromaddr});
	//console.log(x)
	var addressList = [];
	for(var i=0; i<x.toNumber() ; i++ ){
		var yy = contract.query_sensor(sensor_type,i,{from:fromaddr});
		console.log(yy);
		addressList.push(yy);
	}
	return(addressList);
}

//query_sensor (uint sensor_type, uint index)


//sensor_data_push (address vendor_address, uint sensor_type, string schema, uint timestamp, string spatial, string swarm)

window.dataPush = function(fromaddr,password,sensor_type,schema,timestamp,spatial,swarm){
	web3.personal.unlockAccount(fromaddr,password,30);
	contract.sensor_data_push(fromaddr,sensor_type,schema,timestamp.valueOf(),spatial,swarm,{from:fromaddr,gas:3000000});
}

//sensor_data_pull (address vendor_address, uint sensor_type, uint index)
window.dataPull = function(fromaddr,password,vendor_address,sensor_type){
	web3.personal.unlockAccount(fromaddr,password,30);
	var sensorLength = contract.sensor_data_length(vendor_address,sensor_type,{from:fromaddr});
	var listVendorSpecificData = [];
	for(var i = 0; i<sensorLength.toNumber(); i++){
		var yy= contract.sensor_data_pull(vendor_address,sensor_type,i,{from:fromaddr});
		console.log(yy);
		listVendorSpecificData.push(yy);
	}
	return(listVendorSpecificData);

}
 




